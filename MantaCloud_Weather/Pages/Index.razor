@page "/"
@using MantaRays_Weather.Enums;
@inject IConfiguration _config
@inject IHttpClientFactory _clientFactory
@inject IForecastAPIService _forecastService
@using MantaRays_Weather.Components

<div class="inputHeader">
    <InputNumber placeholder="Enter a ZipCode" class="p-2" @bind-Value="zipCode" />
    <button class="mx-2 btn btn-primary" @onclick="() => FetchWeatherForecast(zipCode.ToString())">Get Forecast</button>
</div>
@if (forecast is null)
{ 
    @if (!string.IsNullOrEmpty(errorString))
    {
        <h3>Loading...</h3>
        <p class="alert-danger">@errorString</p>
    }
    @if(isLoading)
    {
        <h3>Loading...</h3>
    }
}
else
{    
    <div class="nav-tabs">
        <button @onclick="() => SetSelectedTab(Tabs.Today)"
                class="tab-button @(SelectedTab == Tabs.Today ? "active" : string.Empty)">
            Today
        </button>
        <button @onclick="() => SetSelectedTab(Tabs.Hourly)"
                class="tab-button @(SelectedTab == Tabs.Hourly ? "active" : string.Empty)">
            Hourly
        </button>
        <button @onclick="() => SetSelectedTab(Tabs.Daily)"
                class="tab-button @(SelectedTab == Tabs.Daily ? "active" : string.Empty)">
            Daily
        </button>
    </div>
    <div class="forecastWrapper">
        @if (SelectedTab == Tabs.Today)
        {
            <Today ErrorString="errorString" />
        }
        else if (SelectedTab == Tabs.Hourly)
        {
            <Hourly Forecast="hourlyForecast" ErrorString="errorString" />
        }
        else if (SelectedTab == Tabs.Daily)
        {
            <Daily Forecast="forecast" ErrorString="errorString" />
        }
    </div>
}


@code {
    private DailyForecast? forecast; 
    private HourlyForecast? hourlyForecast;
    private enum Tabs { Today, Hourly, Daily };
    private Tabs SelectedTab { get; set; } = Tabs.Daily;

    private int? zipCode = null;
    private string errorString = "";  
    private bool isLoading = false;

    protected override async Task OnInitializedAsync()
    {

    }

    private async Task FetchWeatherForecast(string zip)
    {
        if (zip.Length != 5)
        {
            errorString = "Please enter a valid 5 digit zip code.";
            return;
        }
        isLoading = true;
        forecast = await _forecastService.GetForecastByZip<DailyForecast>(zip, ForecastType.Daily);
        if (forecast == null)
        {
            errorString = "Failed to fetch Weather Forecast.";
            return;
        }
        hourlyForecast = await _forecastService.GetForecastByZip<HourlyForecast>(zip, ForecastType.Hourly);
        isLoading = false;

        errorString = "";
    }

    private void Clear()
    {
        forecast = null;
        errorString = "";
    }

    private void SetSelectedTab(Tabs tab)
    {
        SelectedTab = tab;
    }

}